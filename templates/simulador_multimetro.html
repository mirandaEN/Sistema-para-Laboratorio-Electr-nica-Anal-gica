<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Multímetro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Draggable.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        #game-container {
            max-width: 1200px;
            height: 80vh;
            min-height: 600px;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative; /* Necesario para posicionar el SVG de las sondas */
        }
        .multimeter-dial {
            transform-origin: 50% 50%;
            cursor: pointer;
        }
        .probe { cursor: grab; }
        .probe:active { cursor: grabbing; }

        /* Ya no necesita la propiedad 'r', se define en el HTML */
        .probe-tip { 
            stroke-width: 2;
        }
        .target {
            stroke: #374151;
            fill: #ffffff;
            stroke-width: 2;
            cursor: pointer;
            transition: fill 0.2s, stroke 0.2s;
        }
        .target:hover {
            stroke: #2563eb;
            fill: #eff6ff;
        }
        .target-connected {
            fill: #10b981;
            stroke: #059669;
        }
        #lcd-display { fill: #9CA3AF; font-family: monospace; }
        #lcd-text { fill: #111827; font-size: 32px; font-weight: bold; }
        .flash-message {
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(10px);
        }
        .flash-visible { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="p-4">

    <div id="feedback-message" class="flash-message fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white z-50"></div>

    <div id="game-container" class="mx-auto flex bg-white border border-gray-200 overflow-hidden">
        
        <div id="circuit-panel" class="w-2/3 p-8 border-r border-gray-200 flex flex-col justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Simulador de Multímetro Seguro</h1>
                <p class="text-gray-500 mb-6">Arrastra la sonda roja y gira la perilla para medir.</p>

                <svg id="circuit-svg" viewBox="0 0 600 300" class="w-full h-auto bg-white border border-gray-300 rounded-lg shadow-inner">
                    <rect x="50" y="50" width="500" height="200" fill="#E5E7EB" rx="10"/>
                    <rect x="70" y="80" width="40" height="100" fill="#FBBF24" rx="5"/>
                    <text x="90" y="140" fill="#1F2937" font-size="12" text-anchor="middle">12 V</text>
                    <rect x="150" y="130" width="100" height="20" fill="#EF4444" rx="5"/>
                    <text x="200" y="145" fill="#1F2937" font-size="12" text-anchor="middle">100 Ω</text>
                    <rect x="350" y="130" width="100" height="20" fill="#10B981" rx="5"/>
                    <text x="400" y="145" fill="#1F2937" font-size="12" text-anchor="middle">50 Ω</text>
                    <circle id="targetA" class="target" cx="110" cy="180" r="12" data-type="V" data-value="12.0" data-label="Punto A"/>
                    <text x="110" y="205" fill="#1F2937" font-size="14" text-anchor="middle">A</text>
                    <circle id="targetB" class="target" cx="250" cy="140" r="12" data-type="V" data-value="8.0" data-label="Punto B"/>
                    <text x="250" y="165" fill="#1F2937" font-size="14" text-anchor="middle">B</text>
                    <circle id="targetC" class="target" cx="450" cy="140" r="12" data-type="R" data-value="150" data-label="Punto C"/>
                    <text x="450" y="165" fill="#1F2937" font-size="14" text-anchor="middle">C</text>
                    <circle id="targetGND" class="target" cx="70" cy="180" r="12" data-type="GND" data-value="0.0" data-label="GND"/>
                    <text x="70" y="205" fill="#1F2937" font-size="14" text-anchor="middle">GND</text>
                </svg>
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Instrucciones</h3>
                <ul class="list-disc list-inside text-sm text-gray-600">
                    <li>Voltaje (V): Mide entre dos puntos del circuito.</li>
                    <li>Resistencia (Ω): Mide en un circuito **SIN ENERGÍA**.</li>
                    <li class="font-bold text-red-500">Advertencia: Medir voltaje en modo Amperaje (A) quemará el fusible.</li>
                </ul>
            </div>
        </div>

        <div id="multimeter-panel" class="w-1/3 p-6 flex flex-col items-center bg-gray-100">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Multímetro Digital</h2>
            <svg viewBox="0 0 300 350" class="w-full h-auto">
                <rect x="20" y="20" width="260" height="310" rx="20" fill="#374151" stroke="#1F2937" stroke-width="4"/>
                <rect x="40" y="40" width="220" height="70" rx="5" id="lcd-display"/>
                <text x="150" y="88" id="lcd-text" text-anchor="middle">OFF</text>
                <circle cx="150" cy="200" r="60" fill="#1F2937" stroke="#4B5563" stroke-width="3"/>
                <circle cx="150" cy="200" r="50" fill="#9CA3AF"/>
                <text x="180" y="130" font-size="14" fill="white">V~</text>
                <text x="210" y="170" font-size="14" fill="white">V</text>
                <text x="210" y="235" font-size="14" fill="white">Ω</text>
                <text x="180" y="275" font-size="14" fill="white">A</text>
                <g id="dial-indicator" class="multimeter-dial" transform="rotate(270, 150, 200)">
                    <rect x="140" y="145" width="20" height="55" fill="#DC2626" rx="5"/>
                </g>
                <circle cx="110" cy="295" r="15" fill="#262626" id="com-port"/>
                <circle cx="190" cy="295" r="15" fill="#DC2626" id="main-port"/>
            </svg>
        </div>

        <svg id="probe-svg" class="absolute w-full h-full top-0 left-0 pointer-events-none">
            <line id="probeBlackLine" stroke="#111827" stroke-width="2.5"/>
            <circle id="probeBlackTip" class="probe-tip" fill="#111827" r="5"/>
            
            <line id="probeRedLine" stroke="#DC2626" stroke-width="2.5"/>
             <circle id="probeRedTip" class="probe probe-tip" fill="#DC2626" r="5" style="pointer-events: all;"/>
        </svg>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        gsap.registerPlugin(Draggable);

        // --- ELEMENTOS DEL DOM ---
        const dialIndicator = document.getElementById('dial-indicator');
        const lcdText = document.getElementById('lcd-text');
        const targets = Array.from(document.querySelectorAll('.target'));
        const feedbackMessage = document.getElementById('feedback-message');
        const probeRedTip = document.getElementById('probeRedTip');
        const probeRedLine = document.getElementById('probeRedLine');
        const probeBlackTip = document.getElementById('probeBlackTip');
        const probeBlackLine = document.getElementById('probeBlackLine');
        const mainPort = document.getElementById('main-port');
        const comPort = document.getElementById('com-port');

        // --- ESTADO DE LA SIMULACIÓN ---
        let currentFunction = 'OFF';
        let connectedTargets = { red: null, black: 'targetGND' };

        // --- FUNCIONES ---
        const getAbsCoords = (element) => {
            const rect = element.getBoundingClientRect();
            return {
                x: rect.left + rect.width / 2 + window.scrollX,
                y: rect.top + rect.height / 2 + window.scrollY
            };
        }

        function showFeedback(message, type) {
            feedbackMessage.textContent = message;
            feedbackMessage.className = 'flash-message fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 flash-visible';
            const colorClass = type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-red-600';
            feedbackMessage.classList.add(colorClass);

            gsap.to(feedbackMessage, {
                opacity: 0, y: -10, duration: 0.5, delay: 3,
                onComplete: () => feedbackMessage.className = 'flash-message fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white z-50'
            });
        }
        
        function performMeasurement() {
            // Lógica de medición (sin cambios)
            if (currentFunction === 'OFF') { lcdText.textContent = 'OFF'; return; }
            if (!connectedTargets.red || !connectedTargets.black) { lcdText.textContent = '---'; return; }

            const targetRed = document.getElementById(connectedTargets.red);
            const targetBlack = document.getElementById(connectedTargets.black);
            
            const valueRed = parseFloat(targetRed.dataset.value), typeRed = targetRed.dataset.type;
            const valueBlack = parseFloat(targetBlack.dataset.value), typeBlack = targetBlack.dataset.type;

            if (connectedTargets.red === connectedTargets.black) { lcdText.textContent = currentFunction === 'Ω' ? "0.00 Ω" : "0.00 V"; return; }
            if (currentFunction === 'A' && (typeRed === 'V' || typeBlack === 'V')) {
                gsap.to(probeRedTip, { fill: '#FFD700', repeat: 5, yoyo: true, duration: 0.1 });
                lcdText.textContent = "FUSE";
                showFeedback("¡FUSIBLE QUEMADO! No se mide voltaje en modo Amperaje.", 'error'); return;
            }
            if (currentFunction === 'V' || currentFunction === 'V~') {
                if ((typeRed === 'V' || typeRed === 'GND') && (typeBlack === 'V' || typeBlack === 'GND')) {
                    lcdText.textContent = `${Math.abs(valueRed - valueBlack).toFixed(2)} V`;
                } else { lcdText.textContent = "OL"; }
                return;
            }
            if (currentFunction === 'Ω') {
                if (typeRed === 'R' && typeBlack === 'GND') {
                    lcdText.textContent = `${valueRed.toFixed(1)} Ω`;
                } else if (typeRed === 'V' || typeBlack === 'V') {
                    lcdText.textContent = "OL";
                    showFeedback("¡ERROR! Mide resistencia solo en circuitos SIN energía.", 'warning');
                } else { lcdText.textContent = "OL"; }
                return;
            }
            lcdText.textContent = "---";
        }

        // --- INTERACCIONES ---
        Draggable.create(dialIndicator, {
            type: "rotation",
            bounds: { minRotation: 270, maxRotation: 420 },
            liveSnap: true,
            snap: [270, 300, 330, 360 + 30, 360 + 60],
            onDragEnd: function() {
                let r = this.rotation % 360;
                r = r < 0 ? r + 360 : r;
                let fn = 'OFF';
                if (r >= 290 && r < 315) fn = 'V~';
                else if (r >= 315 && r < 345) fn = 'V';
                else if (r >= 15 && r < 45) fn = 'Ω';
                else if (r >= 45 && r < 75) fn = 'A';
                if (fn !== currentFunction) {
                    currentFunction = fn;
                    showFeedback(`Función: ${currentFunction}`, 'warning');
                    performMeasurement();
                }
            }
        });

        Draggable.create(probeRedTip, {
            bounds: window,
            onPress: function() { gsap.to(this.target, { attr: { r: 8 }, duration: 0.1 }); },
            onDrag: function() {
                const portCoords = getAbsCoords(mainPort);
                gsap.set(probeRedLine, { attr: { x1: portCoords.x, y1: portCoords.y, x2: this.pointerX, y2: this.pointerY } });
            },
            onRelease: function() {
                gsap.to(this.target, { attr: { r: 5 }, duration: 0.1 });
                if (connectedTargets.red) document.getElementById(connectedTargets.red).classList.remove('target-connected');
                
                let closestTarget = null, minDistance = 40;
                targets.forEach(target => {
                    const targetCoords = getAbsCoords(target);
                    const distance = Math.hypot(this.pointerX - targetCoords.x, this.pointerY - targetCoords.y);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestTarget = target;
                    }
                });

                if (closestTarget) {
                    connectedTargets.red = closestTarget.id;
                    closestTarget.classList.add('target-connected');
                    const targetCoords = getAbsCoords(closestTarget);
                    gsap.to(this.target, { attr: { cx: targetCoords.x, cy: targetCoords.y }, duration: 0.2 });
                    gsap.to(probeRedLine, { attr: { x2: targetCoords.x, y2: targetCoords.y }, duration: 0.2 });
                } else {
                    connectedTargets.red = null;
                    const portCoords = getAbsCoords(mainPort);
                    gsap.to(this.target, { attr: { cx: portCoords.x, cy: portCoords.y }, duration: 0.3 });
                    gsap.to(probeRedLine, { attr: { x2: portCoords.x, y2: portCoords.y }, duration: 0.3 });
                }
                performMeasurement();
            }
        });

        // --- INICIALIZACIÓN ---
        function updateProbePositions() {
            const mainPortCoords = getAbsCoords(mainPort);
            const comPortCoords = getAbsCoords(comPort);
            const gndTargetCoords = getAbsCoords(document.getElementById('targetGND'));

            gsap.set(probeBlackTip, { attr: { cx: gndTargetCoords.x, cy: gndTargetCoords.y } });
            gsap.set(probeBlackLine, { attr: { x1: comPortCoords.x, y1: comPortCoords.y, x2: gndTargetCoords.x, y2: gndTargetCoords.y } });

            if (!connectedTargets.red) {
                gsap.set(probeRedTip, { attr: { cx: mainPortCoords.x, cy: mainPortCoords.y } });
                gsap.set(probeRedLine, { attr: { x1: mainPortCoords.x, y1: mainPortCoords.y, x2: mainPortCoords.x, y2: mainPortCoords.y } });
            }
        }

        function initialize() {
            document.getElementById('targetGND').classList.add('target-connected');
            updateProbePositions();
            window.addEventListener('resize', updateProbePositions);
            showFeedback("Simulador listo. ¡A medir!", 'success');
        }

        initialize();
    });
    </script>
</body>
</html>